<html layout:decorate="layouts/layout" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">

<div layout:fragment="content">

    <th:block th:fragment="custom-css">
        <style>
            .wider-column {
                width: 300px;
            }

            .contents-container1 { position: relative;}
            /*.textset { margin-bottom: 0;}*/
        </style>
    </th:block>

    <div style="display: flex; flex-direction: column; justify-content: center;">
        <div class="contents-contagginer1 container-md">
            <div class="textset">
                <h2 class="textset-tit" style="text-align: left; margin-left: 100px; font-size: 18px;">My Style</h2>
                <div class="hr-container" style="display: flex; justify-content: center;">
                    <hr class="hr-style first-hr" style="border: solid 1px black; width: 88%;">
                </div>
            </div>
        </div>
        <div class="basic-N45" data-bid="aGLrPw1vOT">
            <div style="display: flex; flex-direction: column; justify-content: center; align-items: center;" class="contents-container1 container-md2">
                <div style="position: relative;">
                    <img class="object-cover" style = "width: 500px; height: 500px;" th:src="${coordiDetailDto.image}" alt="베스트코디 이미지">
<!--                    <div class="like-container" style="position: absolute; bottom: -40px; left: 0; display: flex; align-items: center;">-->
<!--                        <button class="like-button" onclick="toggleLikeCoordi(this)" style="padding: 5px; width: 30px; height: 30px;">-->
<!--                            <img class="like-icon" src="../images/unlike.png" width="20" height="20"/>-->
<!--                        </button>-->
<!--                        <span class="like-count" th:text="${coordiDetailDto.totalLike}" style="margin-left: 5px;"></span>-->
<!--                    </div>-->
                    <div style="display: flex; flex-direction: row;">
                        <div class="cardset-actions"
                             th:attr="data-heart=${coordiDetailDto.coordiId}"
                             onclick="toggleLikeCoordi(this)">
                            <img th:if="${coordiDetailDto.liked}" src="../images/like.png"
                                 width="34" height="34" />
                            <img th:unless="${coordiDetailDto.liked}" src="../images/unlike.png"
                                 width="34" height="34"/>
                        </div>
                        <span th:text="${coordiDetailDto.totalLike}" style="margin-left: 5px; font-size: 2rem;"></span>
                    </div>
                </div>
                <hr class="hr-style second-hr" style="border: solid 1px black; width: 70%; margin-top: 80px; margin-bottom: 10px;">
                <div id="section-inquiry" class="section-content mt-10" style="overflow-y: visible; max-height: 500px;">
                    <h2 class="text-4xl font-bold mb-8" style="text-align: left; font-size: 18px;">댓글</h2>

                    <table class="w-full border-collapse border border-gray-300 mt-8">
                        <thead>
                        <tr class="bg-gray-100">
                            <th class="py-3 px-6 border-b text-xl text-center">프로필</th>
                            <th class="py-3 px-6 border-b text-xl text-center">닉네임</th>
                            <th class="py-3 px-6 border-b text-xl text-center">내용</th>
                            <th class="py-3 px-6 border-b text-xl text-center">작성일시</th>
                            <th class="py-3 px-6 border-b text-xl text-center">비고</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- 상품문의 목록 반복 -->
                        <tr th:each="review : ${paging.content}" class="border-b">
                            <td class="py-3 px-6 text-xl">
                                <img th:src="${review.user.profile}" alt="Profile Image" style="border-radius: 50%; width: 30px; height: 30px;">
                            </td>
                            <td class="py-3 px-6 text-xl text-center" th:text="${review.user.nickname}"></td>
                            <td class="py-3 px-6 text-xl text-center wider-column" th:text="${review.content}"></td>
                            <td class="py-3 px-6 text-xl text-center" th:text="${review.createAt}"></td>
                            <td>
                                <button class="btn btn-dark" style="margin-left: 10px; font-size: 13px;">삭제</button>
                            </td>
                        </tr>
                        </tbody>
                    </table>

                    <div th:if="${!paging.isEmpty()}" class="mt-8">
                        <ul class="pagination flex justify-center" style="margin-bottom: 15px;" >
                            <li class="page-item" th:classappend="${!paging.hasPrevious} ? 'disabled'">
                                <a class="page-link" th:href="@{|/coordi/${coordiDetailDto.coordiId}?page=${paging.number}}">
                                    <span class="text-xl">이전</span>
                                </a>
                            </li>
                            <li th:each="page: ${#numbers.sequence(1, paging.totalPages)}"
                                th:if="${page >= paging.number-5 and page <= paging.number+5}"
                                th:classappend="${page == paging.number + 1} ? 'active'"
                                class="page-item mx-2">
                                <a th:text="${page}" class="page-link" th:href="@{|/coordi/${coordiDetailDto.coordiId}?page=${page}|}"></a>
                            </li>
                            <li class="page-item" th:classappend="${!paging.hasNext} ? 'disabled'">
                                <a class="page-link" th:href="@{|/coordi/${coordiDetailDto.coordiId}?page=${paging.number+2}|}">
                                    <span class="text-xl">다음</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="hr-container" style="display: flex; justify-content: center;">
                    <hr class="hr-style first-hr" style="border: solid 1px black; width: 88%;">
                </div>
            </div>
        </div>
    </div>
</div>
<div layout:fragment="script">
    <script th:inline="javascript">
        function toggleLikeCoordi(element) {
            var csrfToken = [[${_csrf.token}]];
            var heartContainer = element;
            var coordiId = heartContainer.getAttribute('data-heart');
            var currentState = heartContainer.getAttribute('data-liked');
            var newState = currentState === 'true' ? 'false' : 'true';
            // UI 갱신

            // 변경된 상태를 서버로 전송
            fetch('/api/coordi/liked', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': csrfToken,
                },
                body: JSON.stringify({
                    coordiId: parseInt(coordiId),
                }),
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    if (data === true) {
                        heartContainer.innerHTML = '<img src="../images/like.png" width="34" height="34"/>';
                        var likeCount = parseInt(heartContainer.nextElementSibling.innerText);
                        heartContainer.nextElementSibling.innerText = likeCount + 1;
                        heartContainer.setAttribute('data-liked', !newState);
                    } else if (data === false) {
                        heartContainer.innerHTML = '<img src="../images/unlike.png" width="34" height="34"/>';
                        var likeCount = parseInt(heartContainer.nextElementSibling.innerText);
                        heartContainer.nextElementSibling.innerText = likeCount - 1;
                        heartContainer.setAttribute('data-liked', !newState);
                    } else {
                        if (confirm('로그인이 필요한 서비스입니다. 로그인페이지로 이동하시겠습니까?')) {
                            window.location.href = '/members/login';
                        }
                    }

                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        window.onload = function() {
            var firstHr = document.querySelector('.first-hr');
            var secondHr = document.querySelector('.second-hr');
            var containerWidth = document.querySelector('.hr-container').offsetWidth;

            firstHr.style.width = containerWidth * 0.88 + 'px';
            secondHr.style.width = containerWidth * 0.88 + 'px';
        };

    </script>
</div>
</html>
